name: Comprehensive Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run comprehensive tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # Python Package Testing
  python-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install system dependencies
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          sudo apt-get update
          sudo apt-get install -y build-essential
        elif [ "$RUNNER_OS" == "macOS" ]; then
          brew install openssl
        fi

    - name: Install Python dependencies
      working-directory: ./promptops-client
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,redis,otel,test]"

    - name: Run linting
      working-directory: ./promptops-client
      run: |
        black --check promptops tests
        isort --check-only promptops tests
        flake8 promptops tests
        mypy promptops

    - name: Run security checks
      working-directory: ./promptops-client
      run: |
        bandit -r promptops/
        safety check

    - name: Run unit tests
      working-directory: ./promptops-client
      env:
        REDIS_URL: redis://localhost:6379
        TESTING: true
      run: |
        pytest tests/ \
          --cov=promptops \
          --cov-report=xml \
          --cov-report=term-missing \
          --cov-fail-under=80 \
          -v \
          --tb=short

    - name: Run integration tests
      working-directory: ./promptops-client
      env:
        REDIS_URL: redis://localhost:6379
        TESTING: true
        TEST_API_KEY: test-key
        TEST_BASE_URL: http://localhost:8000
      run: |
        pytest tests/integration/ \
          --cov=promptops \
          --cov-report=xml \
          --cov-append \
          -v \
          --tb=short

    - name: Run performance tests
      working-directory: ./promptops-client
      env:
        REDIS_URL: redis://localhost:6379
        TESTING: true
      run: |
        pytest tests/performance/ \
          --benchmark-only \
          --benchmark-sort=mean \
          -v

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./promptops-client/coverage.xml
        flags: python
        name: python-${{ matrix.python-version }}-${{ matrix.os }}

  # JavaScript Package Testing
  javascript-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [16, 18, 20, 21]

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: 'promptops-client-npm/package-lock.json'

    - name: Install dependencies
      working-directory: ./promptops-client-npm
      run: npm ci

    - name: Run linting
      working-directory: ./promptops-client-npm
      run: |
        npm run lint
        npm run format:check

    - name: Run type checking
      working-directory: ./promptops-client-npm
      run: |
        npx tsc --noEmit

    - name: Run security audit
      working-directory: ./promptops-client-npm
      run: |
        npm audit --audit-level moderate

    - name: Run unit tests
      working-directory: ./promptops-client-npm
      env:
        REDIS_URL: redis://localhost:6379
        NODE_ENV: test
      run: |
        npm test -- --coverage \
          --coverage-reporters=text \
          --coverage-reporters=lcov \
          --verbose

    - name: Run integration tests
      working-directory: ./promptops-client-npm
      env:
        REDIS_URL: redis://localhost:6379
        NODE_ENV: test
        TEST_API_KEY: test-key
        TEST_BASE_URL: http://localhost:8000
      run: |
        npm run test:integration

    - name: Run performance tests
      working-directory: ./promptops-client-npm
      env:
        REDIS_URL: redis://localhost:6379
        NODE_ENV: test
      run: |
        npm run test:performance

    - name: Run E2E tests
      working-directory: ./promptops-client-npm
      env:
        REDIS_URL: redis://localhost:6379
        NODE_ENV: test
      run: |
        npm run test:e2e

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./promptops-client-npm/coverage/lcov.info
        flags: javascript
        name: javascript-${{ matrix.node-version }}-${{ matrix.os }}

  # CLI Testing
  cli-tests:
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'promptops-client-npm/package-lock.json'

    - name: Install Python dependencies
      working-directory: ./promptops-client
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,redis,otel,test]"

    - name: Install JavaScript dependencies
      working-directory: ./promptops-client-npm
      run: npm ci

    - name: Test Python CLI
      working-directory: ./promptops-client
      env:
        REDIS_URL: redis://localhost:6379
        TESTING: true
      run: |
        # Test CLI installation
        promptops --version
        promptops --help

        # Test CLI commands
        promptops test --api-key test-key
        promptops health --api-key test-key
        promptops list --api-key test-key --module-id test

        # Test interactive mode simulation
        echo -e "help\nexit" | promptops interactive --api-key test-key

    - name: Test JavaScript CLI
      working-directory: ./promptops-client-npm
      env:
        REDIS_URL: redis://localhost:6379
        NODE_ENV: test
      run: |
        # Test CLI installation
        npx promptops --version
        npx promptops --help

        # Test CLI commands
        npx promptops test --api-key test-key
        npx promptops health --api-key test-key
        npx promptops list --api-key test-key --module-id test

        # Test interactive mode simulation
        echo -e "help\nexit" | npx promptops interactive --api-key test-key

  # Compatibility Testing
  compatibility-tests:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        test-type: [backward-compatibility, forward-compatibility, cross-language]

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'promptops-client-npm/package-lock.json'

    - name: Install dependencies
      working-directory: ./promptops-client
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,redis,otel,test]"

    - name: Install JS dependencies
      working-directory: ./promptops-client-npm
      run: npm ci

    - name: Run ${{ matrix.test-type }} tests
      env:
        REDIS_URL: redis://localhost:6379
        TESTING: true
        NODE_ENV: test
      run: |
        if [ "${{ matrix.test-type }}" = "backward-compatibility" ]; then
          # Test against older versions
          npm run test:backward-compatibility
        elif [ "${{ matrix.test-type }}" = "forward-compatibility" ]; then
          # Test against newer features
          npm run test:forward-compatibility
        elif [ "${{ matrix.test-type }}" = "cross-language" ]; then
          # Test cross-language compatibility
          ./test-packages.sh
        fi

  # Load Testing
  load-tests:
    runs-on: ubuntu-latest
    needs: [python-tests, javascript-tests]

    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'promptops-client-npm/package-lock.json'

    - name: Install dependencies
      working-directory: ./promptops-client
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,redis,otel,test]"
        pip install locust

    - name: Install JS dependencies
      working-directory: ./promptops-client-npm
      run: npm ci
      run: |
        npm install -g k6

    - name: Run Python load tests
      working-directory: ./promptops-client
      env:
        REDIS_URL: redis://localhost:6379
        TESTING: true
      run: |
        locust -f tests/load/locustfile.py --headless --users 100 --spawn-rate 10 --run-time 30s

    - name: Run JavaScript load tests
      working-directory: ./promptops-client-npm
      env:
        REDIS_URL: redis://localhost:6379
        NODE_ENV: test
      run: |
        k6 run tests/load/k6-script.js --vus 100 --duration 30s

  # Security Testing
  security-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'promptops-client-npm/package-lock.json'

    - name: Install Python dependencies
      working-directory: ./promptops-client
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,redis,otel,test]"
        pip install semgrep safety-check

    - name: Install JS dependencies
      working-directory: ./promptops-client-npm
      run: npm ci
      run: |
        npm install -g npm-audit-resolver

    - name: Run Python security scans
      working-directory: ./promptops-client
      run: |
        # Static analysis security testing
        semgrep --config=p/security --error
        bandit -r promptops/ -f json -o bandit-report.json

        # Dependency vulnerability scanning
        safety check --json --output safety-report.json

    - name: Run JavaScript security scans
      working-directory: ./promptops-client-npm
      run: |
        # Static analysis security testing
        npm audit --audit-level critical --json > audit-report.json

        # Run additional security checks
        npm run security:scan

    - name: Upload security reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          **/bandit-report.json
          **/safety-report.json
          **/audit-report.json

  # Test Summary
  test-summary:
    runs-on: ubuntu-latest
    needs: [python-tests, javascript-tests, cli-tests, compatibility-tests, load-tests, security-tests]
    if: always()

    steps:
    - name: Summary
      run: |
        echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY

        echo "| Python Tests | ${{ needs.python-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| JavaScript Tests | ${{ needs.javascript-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| CLI Tests | ${{ needs.cli-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Compatibility Tests | ${{ needs.compatibility-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Load Tests | ${{ needs.load-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Tests | ${{ needs.security-tests.result }} |" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All test jobs have completed. Check individual job logs for details." >> $GITHUB_STEP_SUMMARY